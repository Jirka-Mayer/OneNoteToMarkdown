/*
 * OneNoteToMarkdown.js 0.8.0
 *
 * https://github.com/Jirka-Mayer/OneNoteToMarkdown
 *
 * Copyright (c) 2016 Jiri Mayer
 * Licensed under the MIT license.
 */

+function()
{

var OneNoteToMarkdown = {};

OneNoteToMarkdown.convert=function(o){var t=document.createElement("div");t.innerHTML=o;var e=OneNoteToMarkdown.options.forcedVersion,n=null;null!==e&&(OneNoteToMarkdown.options.supportsOneNoteVersion(e),n=OneNoteToMarkdown.options.oneNoteVersions[e]);var r=new OneNoteToMarkdown.MDBuilder;for(var a in t.children){var i=t.children[a];if("META"!=i.tagName){if(null===e)throw new Error("OneNote version not provided. Are you really copying from a OneNote?");"P"!=i.tagName?"OL"!=i.tagName&&"UL"!=i.tagName||OneNoteToMarkdown.convert_handleListTag(i,r):OneNoteToMarkdown.convert_handleParagraphTag(i,r,n)}else if("Generator"==i.name){if(null!==e)continue;e=i.content,OneNoteToMarkdown.options.supportsOneNoteVersion(e),n=OneNoteToMarkdown.options.oneNoteVersions[e]}}return OneNoteToMarkdown.options.debug&&(console.log("Input HTML (accessible through 'window.div'):"),console.log(t),window.div=t),r.output},OneNoteToMarkdown.convert_handleParagraphTag=function(o,t,e){var n=o.getAttribute("style");null===n&&(t.addParagraph(o.innerText),console.warn("Unknown paragraph tag, treating as a paragraph.")),1==o.children.length&&o.children[0]&&"SPAN"==o.children[0].tagName&&o.children[0].style&&(n+=";"+o.children[0].getAttribute("style")||"");var r="p";for(var a in e)if(n.match(e[a][0])){r=e[a][1];break}"p"==r?t.addParagraph(o.innerHTML):t.addHeading(r,o.innerText)},OneNoteToMarkdown.convert_handleListTag=function(o,t,e){void 0===e&&(e=0),0==e&&t.topMargin(1);var n="OL"==o.tagName,r=0;for(var a in o.children){var i=o.children[a];"LI"!=i.tagName?"OL"!=i.tagName&&"UL"!=i.tagName||OneNoteToMarkdown.convert_handleListTag(i,t,e+1):(r++,n?t.addOL(r,e,i.innerHTML):t.addUL(e,i.innerHTML))}0==e&&t.bottomMargin(1)},OneNoteToMarkdown.handlePaste=function(o){var t=OneNoteToMarkdown.options.clipboardType;if(!(o&&o.clipboardData&&o.clipboardData.types&&o.clipboardData.getData))throw Error("Your browser seems to be too old.");var e=o.clipboardData.types;if(e instanceof DOMStringList&&!e.contains(t)||e.indexOf&&e.indexOf(t)===-1)throw new Error("There's no '"+t+"' in the clipboard, only: "+JSON.stringify(e));var n=o.clipboardData.getData(t),r=OneNoteToMarkdown.convert(n);return r},OneNoteToMarkdown.MDBuilder=function(){this.output="",this.lastMargin=Number.POSITIVE_INFINITY},OneNoteToMarkdown.MDBuilder.prototype.addParagraph=function(o){o=this.parseEmphasis(o),o=this.cureContent(o),this.topMargin(1),this.output+="\n"+o,this.bottomMargin(1)},OneNoteToMarkdown.MDBuilder.prototype.addHeading=function(o,t){t=this.cureContent(t);var e=parseInt(o[1]);if(OneNoteToMarkdown.options.treatTitleAsH1){if(e++,7==e)return void this.addParagraph(t)}else if("h0"==o)return void this.addParagraph(t);this.topMargin(2),this.output+="\n";for(var n=0;n<e;n++)this.output+="#";if(this.output+=" "+t,OneNoteToMarkdown.options.closeHeadings){this.output+=" ";for(var n=0;n<e;n++)this.output+="#"}this.bottomMargin(1)},OneNoteToMarkdown.MDBuilder.prototype.addOL=function(o,t,e){e=this.parseEmphasis(e),e=this.cureContent(e),this.output+="\n";for(var n=0;n<t;n++)this.output+=OneNoteToMarkdown.options.indentation;this.output+=o+". ",this.output+=e},OneNoteToMarkdown.MDBuilder.prototype.addUL=function(o,t){t=this.parseEmphasis(t),t=this.cureContent(t),this.output+="\n";for(var e=0;e<o;e++)this.output+=OneNoteToMarkdown.options.indentation;this.output+=OneNoteToMarkdown.options.listBullets+" ",this.output+=t},OneNoteToMarkdown.MDBuilder.prototype.cureContent=function(o){return o.replace(/\s+/g," ").replace(/\s*<br>\s*/,"<br>")},OneNoteToMarkdown.MDBuilder.prototype.parseEmphasis=function(o){return o.replace(/<span[^>]*?bold[^>]*?italic[^>]*?>([^<]*?)<\/span>/g,"***$1***").replace(/<span[^>]*?italic[^>]*?>([^<]*?)<\/span>/g,"*$1*").replace(/<span[^>]*?bold[^>]*?>([^<]*?)<\/span>/g,"**$1**").replace(/<span[^>]*>([\s\S]*?)<\/span>/g,"$1").replace(/&lt;/g,"<").replace(/&gt;/g,">")},OneNoteToMarkdown.MDBuilder.prototype.topMargin=function(o){for(var t=o-this.lastMargin,e=0;e<t;e++)this.output+="\n"},OneNoteToMarkdown.MDBuilder.prototype.bottomMargin=function(o){for(var t=0;t<o;t++)this.output+="\n";this.lastMargin=o},OneNoteToMarkdown.options={debug:!1,treatTitleAsH1:!0,closeHeadings:!1,listBullets:"*",indentation:"\t",clipboardType:"text/html",forcedVersion:null,oneNoteVersions:{"Microsoft OneNote 15":[['font-family:\\s*"Calibri Light"',"h0"],["font-size:\\s*12.*color:\\s*#5B9BD5.*font-style","h4"],["font-size:\\s*11.*color:\\s*#2E75B5.*font-style","h6"],["font-size:\\s*16.*color:\\s*#1E4E79","h1"],["font-size:\\s*14.*color:\\s*#2E75B5","h2"],["font-size:\\s*12.*color:\\s*#5B9BD5","h3"],["font-size:\\s*11.*color:\\s*#2E75B5","h5"]],"Microsoft OneNote 14":[["font-size:\\s*17","h0"],["font-size:\\s*16","h1"],["font-size:\\s*13","h2"],["font-size:\\s*11.*color.*font-weight.*font-style","h4"],["font-size:\\s*11.*color.*font-weight","h3"],["font-size:\\s*11.*color.*font-style","h6"],["font-size:\\s*11.*color","h5"]]}},OneNoteToMarkdown.options.supportsOneNoteVersion=function(o){if(void 0===OneNoteToMarkdown.options.oneNoteVersions[o])throw new Error("Unsupported OneNote version: "+o)};

////////////////////////////
// Register to the window //
////////////////////////////

window.OneNoteToMarkdown = OneNoteToMarkdown;

}();